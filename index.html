<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Math is Fun - Induk (Login + Unit 1/2/3)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Fredoka',sans-serif;background:#fff7fb;}
    .card{border:3px solid #fce7f3;border-radius:24px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .btn{transition:.1s;border-bottom:5px solid rgba(0,0,0,.2)}
    .btn:active{transform:translateY(4px);border-bottom:0}
    iframe{width:100%;height:820px;border:0;border-radius:20px;overflow:hidden;background:#fff}
  </style>
</head>

<body class="min-h-screen p-4 md:p-6">
  <div class="max-w-7xl mx-auto space-y-6">

    <!-- HEADER -->
    <div class="card p-5 md:p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="text-sm font-bold text-pink-500">Math is Fun</div>
        <div class="text-2xl md:text-3xl font-black text-slate-800">Portal Murid (Login Sekali)</div>
        <div class="text-sm text-slate-500 font-semibold">Unit 1 → Unit 2 → Unit 3 (Jawapan automatik ke Google Sheet)</div>
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="btnUnit1" class="btn px-4 py-2 rounded-xl bg-violet-500 text-white font-bold" onclick="showUnit(1)">Unit 1</button>
        <button id="btnUnit2" class="btn px-4 py-2 rounded-xl bg-slate-200 text-slate-600 font-bold" onclick="showUnit(2)">Unit 2</button>
        <button id="btnUnit3" class="btn px-4 py-2 rounded-xl bg-slate-200 text-slate-600 font-bold" onclick="showUnit(3)">Unit 3</button>
        <button class="btn px-4 py-2 rounded-xl bg-rose-500 text-white font-bold" onclick="resetAll()">Reset</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="loginCard" class="card p-5 md:p-6">
      <div class="text-lg font-black text-slate-800 mb-3">Login Murid</div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input id="nama" class="border-2 border-slate-100 rounded-xl p-3 font-bold outline-none focus:border-violet-400" placeholder="Nama Murid">
        <input id="email" class="border-2 border-slate-100 rounded-xl p-3 font-bold outline-none focus:border-violet-400" placeholder="Email" type="email">
        <input id="kelas" class="border-2 border-slate-100 rounded-xl p-3 font-bold outline-none focus:border-violet-400" placeholder="Kelas">
        <input id="sekolah" class="border-2 border-slate-100 rounded-xl p-3 font-bold outline-none focus:border-violet-400" placeholder="Sekolah (opsyen)">
      </div>
      <div class="mt-4 flex flex-wrap gap-3 items-center">
        <button class="btn px-6 py-3 rounded-2xl bg-violet-600 text-white font-black" onclick="doLogin()">Masuk</button>
        <div id="loginInfo" class="text-sm font-bold text-slate-500"></div>
      </div>
    </div>

    <!-- UNIT AREA -->
    <div id="unitArea" class="card p-4 md:p-5 hidden">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-3">
        <div>
          <div class="text-xs font-black text-slate-400 uppercase tracking-wider">Paparan Unit</div>
          <div id="unitTitle" class="text-xl font-black text-slate-800">Unit 1</div>
          <div id="statusLine" class="text-sm font-bold text-slate-500">Status: Menunggu jawapan dihantar…</div>
        </div>
        <div class="text-xs font-bold text-slate-400">
          *Pastikan Unit 1/2/3 ada kod <span class="text-pink-500">postMessage</span> bila “Hantar/Tamat”.
        </div>
      </div>

      <!-- Tukar src ikut nama fail sebenar tuan -->
      <div id="frame1Wrap"><iframe id="frame1" src="unit1.html"></iframe></div>
      <div id="frame2Wrap" class="hidden"><iframe id="frame2" src="unit2.html"></iframe></div>
      <div id="frame3Wrap" class="hidden"><iframe id="frame3" src="unit3.html"></iframe></div>
    </div>
  </div>

  <script>
    // ==============================
    // URL WEB APP APPS SCRIPT (Tuan bagi)
    // ==============================
    const scriptURL = "https://script.google.com/macros/s/AKfycbz49OWWMgpAT6gE7pCzMOPJrAYI062bWYog-362qXqxNi_CfIxrD6NJK4-iiVJLnXUsYw/exec";

    // ==============================
    // SIMPAN INFO LOGIN
    // ==============================
    const infoMurid = { nama:"", email:"", kelas:"", sekolah:"" };
    let loggedIn = false;

    function doLogin(){
      infoMurid.nama = (document.getElementById("nama").value || "").trim();
      infoMurid.email = (document.getElementById("email").value || "").trim();
      infoMurid.kelas = (document.getElementById("kelas").value || "").trim();
      infoMurid.sekolah = (document.getElementById("sekolah").value || "").trim();

      if(!infoMurid.nama || !infoMurid.email || !infoMurid.kelas){
        document.getElementById("loginInfo").innerText = "❌ Sila isi Nama, Email dan Kelas.";
        return;
      }

      loggedIn = true;
      document.getElementById("loginInfo").innerText = "✅ Login berjaya. Sila mula Unit 1.";
      document.getElementById("loginCard").classList.add("hidden");
      document.getElementById("unitArea").classList.remove("hidden");
      const nama = infoMurid.nama;
const email = infoMurid.email;
const kelas = infoMurid.kelas;
const sekolah = infoMurid.sekolah;

const url = "unit1.html"
  + "?nama=" + encodeURIComponent(nama)
  + "&email=" + encodeURIComponent(email)
  + "&kelas=" + encodeURIComponent(kelas)
  + "&sekolah=" + encodeURIComponent(sekolah);

window.location.href = url;

    }

    function showUnit(n){
      if(!loggedIn){
        alert("Sila login dulu.");
        return;
      }

      // toggle iframe
      document.getElementById("frame1Wrap").classList.toggle("hidden", n !== 1);
      document.getElementById("frame2Wrap").classList.toggle("hidden", n !== 2);
      document.getElementById("frame3Wrap").classList.toggle("hidden", n !== 3);

      // title
      document.getElementById("unitTitle").innerText = "Unit " + n;
      document.getElementById("statusLine").innerText = "Status: Menunggu jawapan dihantar…";

      // button style
      const b1 = document.getElementById("btnUnit1");
      const b2 = document.getElementById("btnUnit2");
      const b3 = document.getElementById("btnUnit3");
      [b1,b2,b3].forEach(b => b.className = "btn px-4 py-2 rounded-xl bg-slate-200 text-slate-600 font-bold");
      (n===1?b1:n===2?b2:b3).className = "btn px-4 py-2 rounded-xl bg-violet-500 text-white font-bold";
    }

    function resetAll(){
      location.reload();
    }

    // ==============================
    // HANTAR KE APPS SCRIPT
    // ==============================
    async function hantarKeSheet(payload){
      const status = document.getElementById("statusLine");
      status.innerText = "Status: Menghantar data ke Google Sheet…";

      try{
        const res = await fetch(scriptURL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        const out = await res.json().catch(()=> ({}));
        if(!out || out.ok !== true){
          throw new Error((out && out.error) ? out.error : "Respon bukan ok");
        }

        status.innerText = "✅ Data berjaya disimpan dalam tab: " + out.sheet;
        return true;

      }catch(err){
        console.error(err);
        status.innerText = "❌ Gagal hantar: " + err.message;
        alert("❌ Gagal hantar ke Google Sheet: " + err.message);
        return false;
      }
    }

    // ==============================
    // TERIMA DATA DARI UNIT (postMessage)
    // Unit akan hantar: {status:"TAMAT", unit:"UNIT 2", jawapan:{...}}
    // ==============================
    window.addEventListener("message", (e) => {
      if(!e.data) return;
      if(e.data.status !== "TAMAT") return;

      const unit = (e.data.unit || "").toString().trim();
      const jawapan = e.data.jawapan || {};

      const payload = {
        timestamp: new Date().toISOString(),
        nama: infoMurid.nama,
        email: infoMurid.email,
        kelas: infoMurid.kelas,
        sekolah: infoMurid.sekolah,
        unit: unit,
        jawapan: jawapan
      };

      hantarKeSheet(payload);
    });
  </script>
</body>
</html>

